
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mapillary VR</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css" type="text/css"/>
  <style type="text/css">
    #map { 
      display: none;
    position: absolute; 
    top: 0; 
    bottom: 0; 
    width: 50%; 
    left: 0; 
    z-index: 10; 
  }
  .mapboxgl-ctrl-geocoder {
    display: none;
  }
    @font-face{
      font-family:"Ionicons";

      src:url("assets/fonts/ionicons.eot?v=2.0.1");
      src:url("assets/fonts/ionicons.eot?v=2.0.1#iefix") format("embedded-opentype"),url("assets/fonts/ionicons.ttf?v=2.0.1") format("truetype"),url("assets/fonts/ionicons.woff?v=2.0.1") format("woff"),url("assets/fonts/ionicons.svg?v=2.0.1#Ionicons") format("svg");

      font-weight:normal;
      font-style:normal
    }
    body{font-family:Ionicons;}
    .visuallyhidden {
      position: absolute;
      display: block;
      border: 0;
      clip: rect(0 0 0 0);
      height: 1px;
      width: 1px;
      margin: -1px;
      padding: 0;
      overflow: hidden;
    }
  </style>

  <script src="aframe-gui.js"></script>


  <script src="gui-env.js"></script>


</head>
<body>
  <div id="map"></div>
  <a-scene>

    <a-assets>
      <!-- Text Canvas -->
      <canvas id="canvasObj" crossorigin="anonymous" webkit-playsinline=""></canvas>
      <a-asset-item id="iconfont" src="assets/fonts/ionicons.ttf"></a-asset-item>
    </a-assets>


    <a-gui-button 
      id="img-0" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true" 
    >
    </a-gui-button>
    <a-gui-button 
      id="img-1" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-2" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-3" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-4" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-5" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-6" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-7" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-8" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-9" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-10" 
      width="2.5" height="2.5" 
      position="0 -5 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>





    <!-- Camera + cursor. 
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-camera look-controls wasd-controls position="0 0 0">
        <a-gui-cursor id="cursor"
              raycaster="objects: [gui-interactable]"
              fuse="true" fuse-timeout="2000"
              design="ring"
        >
        </a-gui-cursor> 
      </a-camera> 
    </a-entity>
    -->


    <a-sky thisimg src="https://cors-anywhere.herokuapp.com/https://images.mapillary.com/oo_5wFkfb1-o-XQ_Zbukcw/thumb-2048.jpg" rotation="0 -130 0" id="my-image"></a-sky>

    <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: [gui-interactable]"></a-entity>
    <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: [gui-interactable]" line="color: #118A7E"></a-entity>



  </a-scene>

  <script type="text/javascript">

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-0.93875203281641,51.005568447565174],
      zoom: 18
    });

    var geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl
    });
    geocoder.onAdd(map);

    geocoder.on('results', function(results) {
       console.log(results);
    })


    //document.getElementById('test_input').value = 'london';






    




    var images = [];

    var seqPos = 0;




    function getSeq(coords) {

      var point = turf.point(coords);
      var buffered = turf.buffer(point, 5, {units: 'miles'});
      var bbox = turf.bbox(buffered);


      



      
      var imglink = "https://a.mapillary.com/v3/images?bbox=" + bbox + "&pano=true&per_page=1&client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";
      console.log(imglink);
      $.getJSON(imglink)
      .done(function(imgdata){

        console.log(imgdata.features[0].properties.sequence_key);



        var seqlink = "https://a.mapillary.com/v3/sequences/" + imgdata.features[0].properties.sequence_key + "?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";
        console.log(seqlink);
        $.getJSON(seqlink)
        .done(function(seqdata){

          window.data = seqdata;

          console.log(seqdata);

          images = [];
          seqPos = 0;


          

          seqdata.properties.coordinateProperties.image_keys.forEach(function(img,index) {
            images.push(img);

            


            



          })

          paintSpots()

          console.log(images);

          var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
          document.querySelector('#my-image').setAttribute('src', imageUrl);

        })


      })
      

    }
    


    var thisSeq = '0-UskBD78xAsg2c9CL0Yag';
    var link = "https://a.mapillary.com/v3/sequences/" + thisSeq + "?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";

    $.getJSON(link)
      .done(function(data){

        window.data = data;

        data.properties.coordinateProperties.image_keys.forEach(function(img,index) {
          images.push(img);

        })

        paintSpots()


        console.log(images);
    })


      var i = 0;



      function paintSpots() {

        console.log(data)

        var centerLng = data.geometry.coordinates[seqPos][0];
        var centerLat = data.geometry.coordinates[seqPos][1];
        var center = turf.point([centerLng,centerLat]);
        console.log(centerLng,centerLat)

          i = 0;

          data.geometry.coordinates.forEach(function(coords,index) {



            if (index > (seqPos-4) && index >= 0) {
              if (index < (seqPos+4)) {

                console.log(seqPos)

                console.log(coords)
                
                let latitude = coords[1];
                let longitude = coords[0];

                console.log(longitude,latitude)
                // threejs json
                var pointX = turf.point([longitude,centerLat]);
                var pointY = turf.point([centerLng,latitude]);
                var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
                var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

                var offsetX = (centerLng- longitude) * 500000;
                var offsetY = (centerLat - latitude) * 500000;

                //addMapillaryPoint(offsetX,offsetY);

                

                //var difference = function (a, b) { return Math.abs(a - b); }

                //var diff = difference(index,5);
                //console.log(index)
                //console.log(diff)

                //var mid = index - diff;

                document.querySelector('#img-'+i).setAttribute('position', {x: offsetY, y: -10, z: offsetX});

                i++

                console.log(index)
                console.log(i)

              }
              
            }


          })
        }















    function jumpToPosition(e) {
      

      var pos = e.path[0].id.slice(-1);
      console.log(pos)

      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[pos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);

      var newSeqPos = parseInt(seqPos) + parseInt(pos);
      seqPos = newSeqPos;

      console.log(seqPos)

      paintSpots()
    }





    function togglePlayback () {

      //document.querySelector('#my-image').setAttribute('src', 'https://sjmarshalluk.github.io/3d-editor/w-16QEt1P1EMvhFtxlc9Tw.jpg');

      


      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);
      seqPos++


    }
    function stop () {
      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);
      seqPos++
    }
    function toggleSound () {
      

    }
    function toggleCaps () {
      
    }







    window.switchKb = function() {
        var keyboardAbcLow = document.getElementById("keyboardAbcLow");
        var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
        var keyboardNum = document.getElementById("keyboardNum");
        var keyboardChar = document.getElementById("keyboardChar");

      if( keyboardAbcLow.getAttribute('position').y == 0){
        window.kbAbcLow = false;
        window.kbAbcHigh = false;
        window.kbNum = true;
        window.kbChar = false;
        toggleKb(window.kbNum);
      }else{
        window.kbAbcLow = true;
        window.kbAbcHigh = false;
        window.kbNum = false;
        window.kbChar = false;
        toggleKb(window.kbAbcLow);
      }
    }

    window.switchKb2 = function() {
        var keyboardAbcLow = document.getElementById("keyboardAbcLow");
        var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
        var keyboardNum = document.getElementById("keyboardNum");
        var keyboardChar = document.getElementById("keyboardChar");

      if(old_timestamp == null || old_timestamp + 100 < event.timeStamp){ //prevent multiple clicks when using keyboard

        if( keyboardNum.getAttribute('position').y == 0){
          window.kbAbcLow = false;
          window.kbAbcHigh = false;
          window.kbNum = false;
          window.kbChar = true;
          toggleKb(window.kbChar);
        }else{
          window.kbAbcLow = false;
          window.kbAbcHigh = false;
          window.kbNum = true;
          window.kbChar = false;
          toggleKb(window.kbNum);
        }
        old_timestamp = event.timeStamp;
      }
    }

    window.addEventListener("keyup", function (event) {
      if (event.defaultPrevented) {
        return; // Do nothing if the event was already processed
      }
      switch (event.keyCode) {
        case 16: // shift
            console.log("shift key release");
            document.getElementById("shiftDown").emit('click');
            break;
        default:
            return; // Quit when this doesn't handle the key event.
        }
      event.preventDefault();
    }, true);



    window.keyCodeToChar = {8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};



    var searchTerm = '';

    window.keypress = function(event) {

      console.log('in window.keypress');
      if(window.old_timestamp == null || window.old_timestamp + 100 < event.timeStamp){ //prevent multiple clicks when using keyboard

        var keyCode = 222;
        var key = null;
        var text = null;

        if(event.target.parentEl.components['gui-interactable']){
          console.log('using parent el: ' + event.target.parentEl.id);
          keyCode = event.target.parentEl.components['gui-interactable']['data']['keyCode'];
          key = event.target.parentEl.components['gui-interactable']['data']['key'];
          var buttonComponent = event.target.parentEl.components['gui-button'];
          var iconButtonComponent = event.target.parentEl.components['gui-icon-button'];
          var iconLabelButtonComponent = event.target.parentEl.components['gui-icon-label-button'];
          if (buttonComponent) {
            text = buttonComponent['data']['text'];
          } else if (iconButtonComponent) {
            text = iconButtonComponent['data']['text'];
          } else if (iconLabelButtonComponent) {
            text = iconLabelButtonComponent['data']['text'];
          }
          console.log("keyCode: " + keyCode);
          console.dir(event.target.parentEl.components['gui-interactable']['data']['keyCode']);
          console.log("keypressed with button: " + keyCode);
        } else {
          console.log('using el: ' + event.target.parentEl.id);
          keyCode = event.target.components['gui-interactable']['data']['keyCode'];
          key = event.target.components['gui-interactable']['data']['key'];
          var buttonComponent = event.target.components['gui-button'];
          var iconButtonComponent = event.target.components['gui-icon-button'];
          var iconLabelButtonComponent = event.target.components['gui-icon-label-button'];
          if (buttonComponent) {
            text = buttonComponent['data']['text'];
          } else if (iconButtonComponent) {
            text = iconButtonComponent['data']['text'];
          } else if (iconLabelButtonComponent) {
            text = iconLabelButtonComponent['data']['text'];
          }
          console.log("keypressed with keyboard: " + keyCode);
        }

        //var textField = document.getElementById("htmlElement");
        //textField.textContent += window.keyCodeToChar[keyCode];
        // var char = window.keyCodeToChar[keyCode];
        if (!text) {
          text = String.fromCharCode(keyCode);
          if (keyCode >= 65 || keyCode <= 90) {
            text = text.toLowerCase();
          }
        }
        var textField = document.getElementById("test_input");
        if (key === 'Backspace') {
          textField.components['gui-input'].delete();
        } else if (text === 'space') {
          textField.components['gui-input'].appendText(' ');
        } else {
          textField.components['gui-input'].appendText(text);

        }
        window.old_timestamp = event.timeStamp;
      }
    }

    window.voicecontrol = function() {
      console.log("voicecontrol");
    }

    window.enter = function() {
      console.log("enter");

      //var textField = document.getElementById("test_input");
      var textField = document.getElementById("test_input");
      var searchTerm = textField.components['gui-input'].oldText;

      console.log(searchTerm);


      var geolink = "https://api.mapbox.com/geocoding/v5/mapbox.places/" + searchTerm + ".json?access_token=pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng";
      $.getJSON(geolink)
        .done(function(data){
          console.log(data)

          getSeq(data.features[0].center)

          var textField = document.getElementById("test_input");
          

      });
    }




    

    </script>

</body>
</html>
