
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
  <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Mapillary VR</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/1.0.4/aframe.min.js"></script>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="https://unpkg.com/osmtogeojson@2.2.12/osmtogeojson.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css" type="text/css"/>
  <style type="text/css">
    #map { 
      display: none;
    position: absolute; 
    top: 0; 
    bottom: 0; 
    width: 50%; 
    left: 0; 
    z-index: 10; 
  }
  .mapboxgl-ctrl-geocoder {
    display: none;
  }
    @font-face{
      font-family:"Ionicons";

      src:url("assets/fonts/ionicons.eot?v=2.0.1");
      src:url("assets/fonts/ionicons.eot?v=2.0.1#iefix") format("embedded-opentype"),url("assets/fonts/ionicons.ttf?v=2.0.1") format("truetype"),url("assets/fonts/ionicons.woff?v=2.0.1") format("woff"),url("assets/fonts/ionicons.svg?v=2.0.1#Ionicons") format("svg");

      font-weight:normal;
      font-style:normal
    }
    body{font-family:Ionicons;}
    .visuallyhidden {
      position: absolute;
      display: block;
      border: 0;
      clip: rect(0 0 0 0);
      height: 1px;
      width: 1px;
      margin: -1px;
      padding: 0;
      overflow: hidden;
    }
  </style>

  <script src="aframe-gui.js"></script>

  <script>
  (function() {

    // Optimization for Repeat Views
    if( sessionStorage.criticalFoftFontsLoaded ) {
      console.log("fonts are already loaded");
      return;
    }

    var guiWebFont = new FontFaceObserver('Fira Sans');

    Promise.all([guiWebFont.load()]).then(function () {
      console.log("fonts are loaded");
      // Optimization for Repeat Views
      sessionStorage.criticalFoftFontsLoaded = true;
    });
  })();


  window.kbAbcLow = true;
  window.kbAbcHigh = false;
  window.kbNum = false;
  window.kbChar = false;
  var old_timestamp = null;

  function toggleKb(kb){
    if(window.kbAbcLow == kb){
      var navkbSwitch = document.getElementById("navkbSwitch");
      navkbSwitch.components['gui-button'].setText('123');
      // navkbSwitch.components['gui-interactable'].setClickAction('switchKbToNum');
      switchKbToAbcLow();
    }else if(window.kbAbcHigh == kb){
      var navkbSwitch = document.getElementById("navkbSwitch");
      navkbSwitch.components['gui-button'].setText('123');
      // navkbSwitch.components['gui-interactable'].setClickAction('switchKbToNum');
      switchKbToAbcHigh();
    }else if(window.kbNum == kb){
      var navkbSwitch = document.getElementById("navkbSwitch");
      navkbSwitch.components['gui-button'].setText('Abc');
      // navkbSwitch.components['gui-interactable'].setClickAction('switchKbToAbcLow');
      switchKbToNum();
    }else if(window.kbChar == kb){
      var navkbSwitch = document.getElementById("navkbSwitch");
      navkbSwitch.components['gui-button'].setText('Abc');
      // navkbSwitch.components['gui-interactable'].setClickAction('switchKbToAbcLow');
      switchKbToChar();
    }
  }

  function switchKbToNum() {
      var keyboardAbcLow = document.getElementById("keyboardAbcLow");
      var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
      var keyboardNum = document.getElementById("keyboardNum");
      var keyboardChar = document.getElementById("keyboardChar");
    console.log(" - switchKbToNum");
    keyboardAbcLow.setAttribute('position','0 -10 -1');
    keyboardAbcHigh.setAttribute('position','0 -10 -1');
    keyboardChar.setAttribute('position','0 -10 -1');
    keyboardNum.setAttribute('position','0 0 0');

    keyboardAbcLow.setAttribute('visible',false);
    keyboardAbcHigh.setAttribute('visible',false);
    keyboardChar.setAttribute('visible',false);
    keyboardNum.setAttribute('visible',true);
  }
  function switchKbToChar() {
      var keyboardAbcLow = document.getElementById("keyboardAbcLow");
      var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
      var keyboardNum = document.getElementById("keyboardNum");
      var keyboardChar = document.getElementById("keyboardChar");
    console.log(" - switchKbToChar");
    keyboardAbcLow.setAttribute('position','0 -10 -1');
    keyboardAbcHigh.setAttribute('position','0 -10 -1');
    keyboardNum.setAttribute('position','0 -10 -1');
    keyboardChar.setAttribute('position','0 0 0');

    keyboardAbcLow.setAttribute('visible',false);
    keyboardAbcHigh.setAttribute('visible',false);
    keyboardNum.setAttribute('visible',false);
    keyboardChar.setAttribute('visible',true);
  }
  function switchKbToAbcHigh() {
      var keyboardAbcLow = document.getElementById("keyboardAbcLow");
      var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
      var keyboardNum = document.getElementById("keyboardNum");
      var keyboardChar = document.getElementById("keyboardChar");
    console.log(" - switchKbToAbcHigh");
    keyboardAbcLow.setAttribute('position','0 -10 -1');
    keyboardNum.setAttribute('position','0 -10 -1');
    keyboardChar.setAttribute('position','0 -10 -1');
    keyboardAbcHigh.setAttribute('position','0 0 0');

    keyboardAbcLow.setAttribute('visible',false);
    keyboardNum.setAttribute('visible',false);
    keyboardChar.setAttribute('visible',false);
    keyboardAbcHigh.setAttribute('visible',true);
  }
  function switchKbToAbcLow() {
      var keyboardAbcLow = document.getElementById("keyboardAbcLow");
      var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
      var keyboardNum = document.getElementById("keyboardNum");
      var keyboardChar = document.getElementById("keyboardChar");
    console.log(" - switchKbToAbcLow");
    keyboardAbcHigh.setAttribute('position','0 -10 -1');
    keyboardNum.setAttribute('position','0 -10 -1');
    keyboardChar.setAttribute('position','0 -10 -1');
    keyboardAbcLow.setAttribute('position','0 0 0');

    keyboardNum.setAttribute('visible',false);
    keyboardChar.setAttribute('visible',false);
    keyboardAbcHigh.setAttribute('visible',false);
    keyboardAbcLow.setAttribute('visible',true);
  }

  </script>




  <script src="gui-env.js"></script>





<script type="text/javascript">
  

AFRAME.registerComponent('mythreejsthing', {
  schema: {
    color: {
      default: '#000'
    },
  },

  update: function() {
    var material = new THREE.MeshBasicMaterial({
      color: this.data.color,
      wireframe: true
    });

    var geometry = new THREE.BoxGeometry(1, 1, 1);

    //this.el.setObject3D('mesh', new THREE.Mesh(geometry, material));
  },

  remove: function() {
    this.el.removeObject3D('mesh');
  }
});

  AFRAME.registerComponent("thisimg", {
    init: function() {
      
    }
  });
</script>





  <script type="module">


/*

const video = document.getElementById('video');
const videoConstraints = {
    facingMode: 'environment'
  };
  const constraints = {
    video: videoConstraints,
    audio: false
  };

  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(error => {
      console.error(error);
    });
*/



document.getElementById('toggle-map').addEventListener('click', function() {
  var editor = document.getElementById("editor");
  editor.classList.toggle("canvas-view");
})

/*
var savedSettings = localStorage.getItem("mysettings");
if (savedSettings) {
  var modelSettings = {
    "buildingHeight": 1,
    "buildingColor": 0x00afaf,
    "roadWidth": 0.003,
    "pathWidth": 0.001
  }
} else {
  var modelSettings = JSON.parse(savedSettings);
}
*/

var modelSettings = {
  "buildingHeight": 0.5,
  "buildingColor": 0x333333,
  "buildingOpacity": 0.5,
  "roadWidth": 0.003,
  "roadColor": 0xCCCCCC,
  "roadOpacity": 1,
  "pathWidth": 0.001,
  "pathColor": 0xCCCCCC,
  "pathOpacity": 1,
  "routeStart": 'none',
  "routeEnd": 'none',
  "routeTurn": 'none',
  "routeType": 'solid',
  "routeWidth": 0.003,
  "routeColor": 0x00afaf,
  "routePosZ": 0.1
}

console.log(modelSettings)


mapboxgl.accessToken = 'pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: [-0.93875203281641,51.005568447565174],
  zoom: 18
});

var geolocate = new mapboxgl.GeolocateControl({
  positionOptions: {
    enableHighAccuracy: true
  },
  trackUserLocation: true,
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl
})
map.addControl(geolocate);

var geocoder = new MapboxGeocoder({
  accessToken: mapboxgl.accessToken,
  mapboxgl: mapboxgl
});




var myObjects = {
  "type":"FeatureCollection",
  "features":[]
};



map.on('load', function() {

  //geolocate.trigger();


map.addSource('objects', {
  'type': 'geojson',
  'data': myObjects
});
map.addLayer({
  'id': 'line-objects',
  'type': 'line',
  'source': 'objects',
  'layout': {
    'line-join': 'round',
    'line-cap': 'round'
  },
  'paint': {
    'line-color': '#888',
    'line-width': 8
  },
  'filter': ['==', '$type', 'LineString']
});


map.addLayer({
  "id": "points",
  "type": "circle",
  "source": 'objects',
  'paint': {
    'circle-radius': 5,
    'circle-color': '#000',
    /*
    'circle-stroke-width': 2,
    'circle-stroke-color': [
      'match',
      ['get', 'status'],
      'verified',
      '#05CB63',
      'removed',
      '#E05643',
      'skipped',
      '#aaaaaa',
      'inactive',
      '#aaaaaa',
      '#EA45CE'
    ],
    */
  },
  'filter': ['==', '$type', 'Point']
});


});

/*
var scaleSlider = document.getElementById("scale-slider");
  scaleSlider.oninput = function() {
    var scaleAmount = this.value / 100;
    root.scale.set(scaleAmount,scaleAmount,scaleAmount)
  }
*/



/*

var firstTime = false;

geolocate.on('geolocate', function() {

  //Get the updated user location, this returns a javascript object.
  var userlocation = geolocate._lastKnownPosition;
  console.log(userlocation)

  //Your work here - Get coordinates like so
  var lat = userlocation.coords.latitude;
  var lng = userlocation.coords.longitude;

  if (firstTime === false) {
    showPosition(userlocation);
    firstTime = true;
  }
});
*/


//var thisImage = 'Sxqxj6JQWmdN8w3660Rf5w';
//var thisImage = 'w-16QEt1P1EMvhFtxlc9Tw';
var thisImage = 'Jqum6TdBCIg5pams-Ey20w';

var link = "https://a.mapillary.com/v3/images/" + thisImage + "?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";


$.getJSON(link)
.done(function(data){


  var userlocation = {
    'coords': {
      'latitude': data.geometry.coordinates[1],
      'longitude': data.geometry.coordinates[0]
    } 
  }
  console.log(userlocation)
  showPosition(userlocation);
      
})


//document.querySelector('#my-image').setAttribute('src', 'https://images.mapillary.com/w-16QEt1P1EMvhFtxlc9Tw/thumb-1024.jpg')

//document.querySelector('#my-image').setAttribute('src', 'Sxqxj6JQWmdN8w3660Rf5w.jpg')





function showPosition(position) {



  window.currentPoint = turf.point([position.coords.longitude, position.coords.latitude]);

  map.jumpTo({ center: [position.coords.longitude, position.coords.latitude], zoom: 17 });


  setScene()
}




/*
directions.on('route', function(e) {

  console.log(e)
})
*/















//setScene();



 


    // Three.js - Load .OBJ ?
// from https://threejsfundamentals.org/threejs/threejs-load-obj-no-materials.html


//import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r119/build/three.module.js';
import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r119/examples/jsm/controls/OrbitControls.js';
import {GLTFLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r119/examples/jsm/loaders/GLTFLoader.js';
import {GLTFExporter} from 'https://threejsfundamentals.org/threejs/resources/threejs/r119/examples/jsm/exporters/GLTFExporter.js';



  const canvas = document.querySelector('#c');
  const renderer = new THREE.WebGLRenderer({canvas});

  const fov = 45;
  const aspect = 2;  // the canvas default
  const near = 1;
  const far = 100;
  const camera = new THREE.PerspectiveCamera(fov, aspect, near, far);
  camera.position.set(0, 1, 0);
  

  const controls = new OrbitControls(camera, canvas);
  controls.target.set(0, 1, 0);
  controls.update();

  var objects = [];
  window.scene = new THREE.Scene();
  scene.background = new THREE.Color('white');


  var light = new THREE.DirectionalLight(0xffffff, 1);
  light.position.set(1, 3, 2);
  scene.add(light);




  /*

  {
    const planeSize = 40;

    const loader = new THREE.TextureLoader();
    const texture = loader.load('https://threejsfundamentals.org/threejs/resources/images/checker.png');
    texture.wrapS = THREE.RepeatWrapping;
    texture.wrapT = THREE.RepeatWrapping;
    texture.magFilter = THREE.NearestFilter;
    const repeats = planeSize / 2;
    texture.repeat.set(repeats, repeats);

    const planeGeo = new THREE.PlaneBufferGeometry(planeSize, planeSize);
    const planeMat = new THREE.MeshPhongMaterial({
      map: texture,
      side: THREE.DoubleSide,
    });
    const mesh = new THREE.Mesh(planeGeo, planeMat);
    mesh.rotation.x = Math.PI * -.5;
    // scene.add(mesh);
  }

  {
    const skyColor = 0xB1E1FF;  // light blue
    const groundColor = 0xB97A20;  // brownish orange
    const intensity = 1;
    const light = new THREE.HemisphereLight(skyColor, groundColor, intensity);
    scene.add(light);
  }

  {
    const color = 0xFFFFFF;
    const intensity = 1;
    const light = new THREE.DirectionalLight(color, intensity);
    light.position.set(0, 10, 0);
    light.target.position.set(-5, 0, 0);
    scene.add(light);
    scene.add(light.target);
  }
  */







  




  function resizeRendererToDisplaySize(renderer) {
    const canvas = renderer.domElement;
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    const needResize = canvas.width !== width || canvas.height !== height;
    if (needResize) {
      renderer.setSize(width, height, false);
    }
    return needResize;
  }

  function render() {

    if (resizeRendererToDisplaySize(renderer)) {
      const canvas = renderer.domElement;
      camera.aspect = canvas.clientWidth / canvas.clientHeight;
      camera.updateProjectionMatrix();
    }

    

    renderer.render(scene, camera);

    requestAnimationFrame(render);
  }

  render()

  //requestAnimationFrame(render);



window.pointType;

function setScene() {




 var bounds = map.getBounds();
  console.log(bounds)
var sceneExtent = turf.polygon([[
    [bounds._ne.lng,bounds._ne.lat],
    [bounds._sw.lng,bounds._ne.lat],
    [bounds._sw.lng,bounds._sw.lat],
    [bounds._ne.lng,bounds._sw.lat],
    [bounds._ne.lng,bounds._ne.lat]
    ]], { name: 'poly1' });
console.log(sceneExtent)


window.center = turf.centerOfMass(sceneExtent);

getOsmBbox();






}


var osmObjects = {
  "type":"FeatureCollection",
  "features":[]
};


var osmLines = {
  "type":"FeatureCollection",
  "features":[]
};
var osmBuildings = {
  "type":"FeatureCollection",
  "features":[]
};
var osmNodes = {
  "type":"FeatureCollection",
  "features":[]
};
var mlyImgNodes = {
  "type":"FeatureCollection",
  "features":[]
}
var mlyNodes = {
  "type":"FeatureCollection",
  "features":[]
}



function getOsmBbox() {
  var bounds = map.getBounds();
  window.searchBbox = bounds._sw.lat + ',' + bounds._sw.lng + ',' + bounds._ne.lat + ',' + bounds._ne.lng;
  showFeature()
  showMapillary(bounds)
}

function queryOsm() {
  if (map.getLayer('features-point')) {
    map.removeLayer('features-point');
  }
  if (map.getLayer('features-polygon')) {
    map.removeLayer('features-polygon');
  }
  if (map.getLayer('features-line')) {
    map.removeLayer('features-line');
  }
  if (map.getSource('feats')) {
    map.removeSource('feats');
  }
  showFeature()
}

function buildOverpassApiUrlFeat() {

  var nodeQuery = '';
  var wayQuery = '';
  var relationQuery = '';

  wayQuery += 'way[building](' + searchBbox + ');'

  wayQuery += 'way[highway](' + searchBbox + ');'

  //nodeQuery += 'node[highway=bus_stop](' + searchBbox + ');'

  nodeQuery += 'node[amenity=waste_basket](' + searchBbox + ');'

  //wayQuery += 'node[entrance](' + searchBbox + ');'



      


  //var nodeQuery = 'node[' + overpassQuery + '](' + searchBbox + ');';
  //var nodeQuery = 'node[tourism=attraction](' + searchBbox + ');node[natural=peak](' + searchBbox + ');';
  //var wayQuery = 'way[' + overpassQuery + '](' + searchBbox + ');';
  //var relationQuery = 'relation[' + overpassQuery + '](' + searchBbox + ');';
  var query = '?data=[out:json][timeout:15];(' + nodeQuery + wayQuery + relationQuery + ');out body geom;';
  var baseUrl = 'https://z.overpass-api.de/api/interpreter';
  var resultUrl = baseUrl + query;
  return resultUrl;
}

/*
function showMapillary(bounds) {
  var mapBounds = bounds._sw.lng + ',' + bounds._sw.lat + ',' + bounds._ne.lng + ',' + bounds._ne.lat;
  var pointsData = 'https://a.mapillary.com/v3/map_features?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh&layers=points&bbox=' + mapBounds + '&per_page=1000&values=object--bench';

  $.getJSON(pointsData)
  .done(function(points){
    console.log(points)
    points.features.forEach(function(result) {

      osmNodes.features.push(result);
    })

    console.log(osmNodes)
    paintNodes();
  })
}
*/

function showMapillary(bounds) {
  var mapBounds = bounds._sw.lng + ',' + bounds._sw.lat + ',' + bounds._ne.lng + ',' + bounds._ne.lat;

  var imglink = "https://a.mapillary.com/v3/images?bbox=" + mapBounds + "&pano=true&per_page=100&client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";



  $.getJSON(imglink)
  .done(function(points){
    console.log(points)
    points.features.forEach(function(result) {

      mlyImgNodes.features.push(result);
    })

    console.log(mlyImgNodes)
    paintImgNodes();
  })



  var binlink = "https://a.mapillary.com/v3/map_features?layers=points&bbox=" + mapBounds + "&values=object--trash-can&client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";



  $.getJSON(binlink)
  .done(function(points){
    console.log(points)
    points.features.forEach(function(result) {

      mlyNodes.features.push(result);
    })

    console.log(mlyImgNodes)
    paintMlyNodes();
  })
}


function showFeature(type,feature,shape){

  //var queryFeatures = type + '=' + feature;
  //var queryFeatures = 'tourism=attraction;natural=peak';
  var overpassApiUrlFeat = buildOverpassApiUrlFeat();
  $.get(overpassApiUrlFeat, function (osmDataAsJson) {
    var resultAsGeojson = osmtogeojson(osmDataAsJson);
    console.log(resultAsGeojson);


    var outlines = {
      "type":"FeatureCollection",
      "features":[]
    };

    var outlinesPoly = {
      "type":"FeatureCollection",
      "features":[]
    }

    



    resultAsGeojson.features.forEach(function(result) {
      if (result.properties.tags.entrance === 'yes') {
        var bufferedDoor = turf.buffer(result, 0.0003, {units: 'kilometers'});
        doors.features.push(bufferedDoor);
      }
      
      if (result.properties.tags.building === 'yes' || result.properties.tags.building === 'parking' || result.properties.tags.building === 'commercial' || result.properties.tags.building === 'office' || result.properties.tags.building === 'apartments') {
        
        result.properties.type = 'building';
        osmObjects.features.push(result);

        osmBuildings.features.push(result);
        console.log(osmBuildings)
      }
      

      if(result.geometry.type == 'Point') {
        if (result.properties.tags.highway == 'bus_stop') {
          result.properties.type = 'bus_stop';
          osmObjects.features.push(result);
        }
      }

      if(result.geometry.type == 'Point') {
        if (result.properties.tags.amenity == 'waste_basket') {
          result.properties.type = 'waste_basket';
          osmNodes.features.push(result);
        }
      }



      if(result.geometry.type == 'LineString') {
        if (result.properties.tags.highway == 'motorway' || result.properties.tags.highway == 'primary' || result.properties.tags.highway == 'secondary' || result.properties.tags.highway == 'tertiary' || result.properties.tags.highway == 'residential' || result.properties.tags.highway == 'unclassified' ) {
          result.properties.type = 'road';
          osmObjects.features.push(result);
        }


        if (result.properties.tags.highway == 'pedestrian' || result.properties.tags.highway == 'footway' ) {
          result.properties.type = 'path';
          osmObjects.features.push(result);
        }

      }
    });

    console.log(osmLines)
    renderOsm()

  });   
}



function paintRoads() {

  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];

  var roads = [];

  osmObjects.features.forEach(function(road,index) {
    if(road.properties.type === 'road') {
      var buffered = turf.buffer(road, modelSettings.roadWidth, {units: 'kilometers'});
      buffered.properties.index = index;
      roads.push(buffered);
    }
  })

  window.roadCount = roads.length;

  roads.forEach(function(rd) {


    var roadPoints = [];

    rd.geometry.coordinates[0].forEach(function(corner,index) {
      let latitude = corner[1];
      let longitude = corner[0];


      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (longitude - centerLng) * 3000;
      var offsetY = (latitude - centerLat) * 3000;

      //addTurn(offsetX,offsetY,bearing);


      roadPoints.push( new THREE.Vector3( offsetY,offsetX ) );



    })




    var shape = new THREE.Shape( roadPoints );

    var extrudeSettings = { amount: 0, bevelEnabled: false, bevelSegments: 2, steps: 2, bevelSize: 1, bevelThickness: 1 };

    var geometry = new THREE.ExtrudeBufferGeometry( shape, extrudeSettings );

    var material = new THREE.MeshBasicMaterial( {
      color: modelSettings.roadColor
    } );

    //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
    var mesh = new THREE.Mesh( geometry, material );

    mesh.position.set( 0, 0, 0 );
    mesh.rotation.set(90 * Math.PI/180,0,0);
    mesh.material.transparent = true;
    mesh.material.opacity = modelSettings.roadOpacity; 
    mesh.name = 'osm-' + rd.properties.index;

    scene.add( mesh );
    


    
    
    
  });


  



  /*

  osmLines.features.forEach(function(road,index) {

    var material = new THREE.LineBasicMaterial({
      color: 0xCCCCCC,
      linewidth: 5
    });

    var points = [];

    osmLines.features[index].geometry.coordinates.forEach(function(turn,index) {
      let latitude = turn[1];
      let longitude = turn[0];


      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (longitude - centerLng) * 10000;
      var offsetY = (latitude - centerLat) * 10000;

      //addTurn(offsetX,offsetY,bearing);


      points.push( new THREE.Vector3( offsetY,0,offsetX ) );



    })



    var geometry = new THREE.BufferGeometry().setFromPoints( points );

    var line = new THREE.Line( geometry, material );
    scene.add( line );
    
  });

  */


  

}


function paintPaths() {

  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];

  var paths = [];

  osmObjects.features.forEach(function(path,index) {
    if(path.properties.type === 'path') {
      var buffered = turf.buffer(path, modelSettings.pathWidth, {units: 'kilometers'});
      buffered.properties.index = index;
      paths.push(buffered);
    }
  })

  window.roadCount = paths.length;

  paths.forEach(function(path) {


    var pathPoints = [];

    path.geometry.coordinates[0].forEach(function(corner,index) {
      let latitude = corner[1];
      let longitude = corner[0];


      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (longitude - centerLng) * 3000;
      var offsetY = (latitude - centerLat) * 3000;

      //addTurn(offsetX,offsetY,bearing);


      pathPoints.push( new THREE.Vector3( offsetY,offsetX ) );



    })




    var shape = new THREE.Shape( pathPoints );

    var extrudeSettings = { amount: 0, bevelEnabled: false, bevelSegments: 2, steps: 2, bevelSize: 1, bevelThickness: 1 };

    var geometry = new THREE.ExtrudeBufferGeometry( shape, extrudeSettings );

    var material = new THREE.MeshBasicMaterial( {
      color: modelSettings.pathColor
    } );

    //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
    var mesh = new THREE.Mesh( geometry, material );

    mesh.position.set( 0, 0.01, 0 );
    mesh.rotation.set(90 * Math.PI/180,0,0);

    mesh.material.transparent = true;
    mesh.material.opacity = modelSettings.pathOpacity; 
    mesh.name = 'osm-' + path.properties.index;

    scene.add( mesh );
    
    
  });


}



function paintBuildings() {
  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];

  window.buildingCount = osmBuildings.features.length;
  

  //osmBuildings.features.forEach(function(building,index) {

  console.log(osmObjects)

  osmObjects.features.forEach(function(building,index) {
    if (building.properties.type === 'building') {

      var buildingPoints = [];

      osmObjects.features[index].geometry.coordinates[0].forEach(function(turn,index) {
        console.log(turn)
        let latitude = turn[1];
        let longitude = turn[0];


        // threejs json
        var pointX = turf.point([longitude,centerLat]);
        var pointY = turf.point([centerLng,latitude]);
        var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
        var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

        var offsetX = (longitude - centerLng) * 3000;
        var offsetY = (latitude - centerLat) * 3000;

        //addTurn(offsetX,offsetY,bearing);


        buildingPoints.push( new THREE.Vector3( offsetY,offsetX ) );



      })


      var shape = new THREE.Shape( buildingPoints );


      var extrudeSettings = { amount: modelSettings.buildingHeight, bevelEnabled: false, bevelSegments: 1, steps: 1, bevelSize: 1, bevelThickness: 1 };
      console.log(buildingPoints)
      var geometry = new THREE.ExtrudeBufferGeometry( shape, extrudeSettings );

      var material = new THREE.MeshStandardMaterial( { color: modelSettings.buildingColor } );

      //var material = new THREE.MeshLambertMaterial( { color: modelSettings.buildingColor, wireframe: false } );
      var mesh = new THREE.Mesh( geometry, material );

      mesh.position.set( 0, modelSettings.buildingHeight, 0 );
      mesh.rotation.set(90 * Math.PI/180,0,0);

      mesh.material.transparent = false;
      mesh.material.opacity = modelSettings.buildingOpacity; 
      mesh.name = 'osm-' + index;

      scene.add( mesh );
      
    }
  });
  
}



function paintNodes(e,type) {
  console.log(osmNodes)
  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];



  osmNodes.features.forEach(function(node,index) {    console.log(e)


    let latitude = node.geometry.coordinates[1];
    let longitude = node.geometry.coordinates[0];

    // threejs json
    var pointX = turf.point([longitude,centerLat]);
    var pointY = turf.point([centerLng,latitude]);
    var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
    var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

    var offsetX = (longitude - centerLng) * 3000;
    var offsetY = (latitude - centerLat) * 3000;


    addOsmBin(offsetX,offsetY);

    

  })




}


function paintImgNodes(e,type) {
  console.log(mlyImgNodes)
  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];



  mlyImgNodes.features.forEach(function(node,index) {    console.log(e)


    let latitude = node.geometry.coordinates[1];
    let longitude = node.geometry.coordinates[0];

    // threejs json
    var pointX = turf.point([longitude,centerLat]);
    var pointY = turf.point([centerLng,latitude]);
    var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
    var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

    var offsetX = (longitude - centerLng) * 3000;
    var offsetY = (latitude - centerLat) * 3000;


    addMapillaryPoint(offsetX,offsetY);

    

  })




}


function paintMlyNodes(e,type) {
  console.log(mlyImgNodes)
  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];



  mlyNodes.features.forEach(function(node,index) {    console.log(e)


    let latitude = node.geometry.coordinates[1];
    let longitude = node.geometry.coordinates[0];

    // threejs json
    var pointX = turf.point([longitude,centerLat]);
    var pointY = turf.point([centerLng,latitude]);
    var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
    var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

    var offsetX = (longitude - centerLng) * 3000;
    var offsetY = (latitude - centerLat) * 3000;


    addMlyBin(offsetX,offsetY);

    

  })




}









function renderOsm() {
  

  

  paintRoads();

  paintPaths();

  paintBuildings();

  paintNodes();





  var dollhouse = document.querySelector('a-scene');


  //this.el.setObject3D('mesh', new THREE.Mesh(geometry, material));
  dollhouse.setObject3D('mesh', scene);

  scene.rotation.y = 25 * Math.PI/180;
  scene.rotation.x = 0 * Math.PI/180;
  scene.rotation.z = 0 * Math.PI/180;

  //dollhouse.setAttribute('rotation', '0 2.3 0');



}
  






function addPoint(e) {

  map.off('click', addPoint)
  console.log(e)

  var point = turf.point([e.lngLat.lng,e.lngLat.lat]);

  point.properties.count = 1;
  myObjects.features.push(point);
  console.log(myObjects)

  updateObjectList();

  // ADD TO MAP


  document.getElementById('myModal').style.display = 'block';


  /*
  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });

  popup.setLngLat([e.lngLat.lng,e.lngLat.lat]).setHTML('<button id="dot">Dot</button><button id="arrow">Arrow</button>').addTo(map);
  */

  document.getElementById('dot').addEventListener('click', function() {
    var type = 'dot';
    setPoint(e,type);
    document.getElementById('myModal').style.display = 'none';
  })
  document.getElementById('arrow').addEventListener('click', function() {
    var type = 'arrow';
    setPoint(e,type);
    document.getElementById('myModal').style.display = 'none';
  })

}




function setPoint(e,type) {
  console.log(e)


  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];



  let latitude = e.lngLat.lat;
  let longitude = e.lngLat.lng;

  // threejs json
  var pointX = turf.point([longitude,centerLat]);
  var pointY = turf.point([centerLng,latitude]);
  var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
  var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

  var offsetX = (longitude - centerLng) * 10000;
  var offsetY = (latitude - centerLat) * 10000;


  if (type === 'dot') {
    addNewPoint(offsetX,offsetY);
  }
  if (type === 'arrow') {
    addNewArrow(offsetX,offsetY);
  }

  


}



function renderPlaces(route,dashSize,model) {

  var centerLng = center.geometry.coordinates[0];
  var centerLat = center.geometry.coordinates[1];

  route.geometry.coordinates.forEach(function(turn,index) {
    let latitude = turn[1];
    let longitude = turn[0];


    if (index < route.geometry.coordinates.length - 1) {
      var thisCoords = route.geometry.coordinates[index];

      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (thisCoords[0] - centerLng) * 10000;
      var offsetY = (thisCoords[1] - centerLat) * 10000;

      console.log(modelSettings.routeTurn);
      if (modelSettings.routeTurn === 'arrow') {
        addNewArrow(offsetX,offsetY);
      }
      if (modelSettings.routeTurn === 'point') {
        addNewPoint(offsetX,offsetY);
      }
      
    }


    

  })


  if (modelSettings.routeType === 'solid') {

    var buffered = turf.buffer(route, modelSettings.routeWidth, {units: 'kilometers'});

    


    var routePoints = [];

    buffered.geometry.coordinates[0].forEach(function(corner,index) {
      console.log(corner)

      let latitude = corner[1];
      let longitude = corner[0];


      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (longitude - centerLng) * 10000;
      var offsetY = (latitude - centerLat) * 10000;

      //addTurn(offsetX,offsetY,bearing);


      routePoints.push( new THREE.Vector3( offsetY,offsetX ) );



    })




    var shape = new THREE.Shape( routePoints );

    var extrudeSettings = { amount: 0, bevelEnabled: false, bevelSegments: 2, steps: 2, bevelSize: 1, bevelThickness: 1 };

    var geometry = new THREE.ExtrudeBufferGeometry( shape, extrudeSettings );

    var material = new THREE.MeshBasicMaterial( {
      color: modelSettings.routeColor
    } );

    //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
    var mesh = new THREE.Mesh( geometry, material );

    mesh.position.set( 0, modelSettings.routePosZ, 0 );
    mesh.rotation.set(0,0,0);
    mesh.name = 'route';

    scene.add( mesh );
      

  } else {



    var arPathPoints = {
      "type":"FeatureCollection",
      "features":[]
    };

    var routeLength = turf.length(route, {units: 'kilometers'});
    var options = {units: 'kilometers'};
    var lengthMetres = routeLength * 1000;

    var i;
    for (i = 0; i < lengthMetres; i++) {
      var distanceAlong = i * dashSize;
      console.log(dashSize)
      var along = turf.along(route, distanceAlong, options);
      arPathPoints.features.push(along)

      if (i === lengthMetres || i > lengthMetres) {
        //console.log(arPathPoints)
      }
    }

    for(i=0; i < arPathPoints.features.length; i++) {

      let latitude = arPathPoints.features[i].geometry.coordinates[1];
      let longitude = arPathPoints.features[i].geometry.coordinates[0];

      // threejs json
      var pointX = turf.point([longitude,centerLat]);
      var pointY = turf.point([centerLng,latitude]);
      var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
      var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

      var offsetX = (longitude - centerLng) * 10000;
      var offsetY = (latitude - centerLat) * 10000;

      addNewPoint(offsetX,offsetY,'route',i,model);



    };


    

    route.properties.count = arPathPoints.features.length;

  }


  
  myObjects.features.push(route);


}





function addMapillaryPoint(offsetX,offsetY) {

  var material = new THREE.MeshBasicMaterial({
      color: '#05cb63',
      wireframe: false
    });

    var geometry = new THREE.BoxGeometry(0.03, 0.03, 0.03);



    //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
    var mesh = new THREE.Mesh( geometry, material );

    mesh.position.set(offsetY,0.2,offsetX);
    mesh.rotation.set(0,-100,0);

    scene.add( mesh );

    


    /*
  const gltfLoader = new GLTFLoader();


  var url = 'https://sjmarshalluk.github.io/model-maker/assets/path/point.gltf';
  
  gltfLoader.load(url, (gltf) => {
    const root = gltf.scene;

    root.position.set(offsetY,0.1,offsetX);
    root.scale.set(0.1,0.1,0.1);
    root.rotation.set(0,0,0);

    scene.add(root);

    //objects.push(root);
    //showControls(root);

  });
  */

  console.log(offsetX,offsetY)
}


function addOsmBin(offsetX,offsetY) {

  var material = new THREE.MeshBasicMaterial({
    color: '#333333',
    wireframe: false
  });

  //var geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);

  var geometry = new THREE.CylinderGeometry( 0.03, 0.03, 0.1, 20 );

  //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
  var mesh = new THREE.Mesh( geometry, material );

  mesh.position.set(offsetY,0,offsetX);
  mesh.rotation.set(0,-100,0);

  scene.add( mesh );

  console.log(offsetX,offsetY)
}



function addMlyBin(offsetX,offsetY) {

  var material = new THREE.MeshBasicMaterial({
    color: '#CCCCCC',
    wireframe: true
  });

  //var geometry = new THREE.BoxGeometry(0.3, 0.3, 0.3);

  var geometry = new THREE.CylinderGeometry( 0.03, 0.03, 0.1, 20 );

  //var material2 = new THREE.MeshLambertMaterial( { color: 0xCCCCCC, emissive: 0x2a2a2a, emissiveIntensity: 1, wireframe: false } );
  var mesh = new THREE.Mesh( geometry, material );

  mesh.position.set(offsetY,0,offsetX);
  mesh.rotation.set(0,-100,0);

  scene.add( mesh );

  console.log(offsetX,offsetY)
}






  </script>


</head>
<body>


  <div id="editor" style="display: none; z-index: 999">

    <button id="toggle-map" class="btn" style="position: absolute; bottom: 10px; left: 10px; z-index: 1000"><</button>

    <div id="map"></div>

    
    <canvas id="c"></canvas>

  </div>


  <a-scene>

    <a-plane position="0 -0.1 0" rotation="-90 0 0" width="8" height="8" color="#7BC8A4" shadow></a-plane>

    <a-assets>
      <!-- Text Canvas -->
      <canvas id="canvasObj" crossorigin="anonymous" webkit-playsinline=""></canvas>
      <a-asset-item id="iconfont" src="assets/fonts/ionicons.ttf"></a-asset-item>
    </a-assets>


    <a-gui-button 
      id="img-0" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value=" "
      margin="0 0 0.05 0"
      toggle="true" 
    >
    </a-gui-button>
    <a-gui-button 
      id="img-1" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-2" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-3" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-4" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-5" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-6" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-7" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-8" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-9" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>
    <a-gui-button 
      id="img-10" 
      width="0.03" height="0.03" 
      position="0 0 0" rotation="-90 0 0" 
      onclick="jumpToPosition" key-code="32"
      value="test button"
      margin="0 0 0.05 0"
      toggle="true"
    >
    </a-gui-button>





     <!-- <a-entity geometry="primitive: box; width:5; height:2; depth:0.01;" position="0 3 -4" material="shader: html; target: #htmlElement; fps:1;"></a-entity> -->
    <a-gui-flex-container
        id="flex"
        flex-direction="column" justify-content="center" align-items="middle" component-padding="0.1"
        opacity="0.7" width="4.5" height="1.5"
        position="0 2.4 -6" rotation="-20 0 0"
    >   <a-gui-input id="test_input"
           width="4" height="0.7"
           onclick="testInputAction"
           value=""
           font-size="160px"
           font-color="#212121"
           border-color="#212121"
           border-hover-color="#424242"
           background-color="#FAFAFA"
           hover-color="#F5F5F5"
           active-color="#FFEB3B"
        >
        </a-gui-input>
    </a-gui-flex-container>

      <a-entity position="0 1 -6" rotation="-35 0 0">
        <a-entity id="keyboardNum" visible="false" position="0 -10 -1">
        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0.5 0"
        >
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:1;"
                gui-button=" text:1; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:2;"
                gui-button=" text:2; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:3;"
                gui-button=" text:3; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:4;"
                gui-button=" text:4; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:5;"
                gui-button=" text:5; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:6;"
                gui-button=" text:6; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:7;"
                gui-button=" text:7; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:8;"
                gui-button=" text:8; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:9;"
                gui-button=" text:9; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:0;"
                gui-button=" text:0; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="-"
                   value="-" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="/"
                   value="/" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=":"
                   value=":" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=";"
                   value=";" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="("
                   value="(" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=")"
                   value=")" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="$"
                   value="$" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="&"
                   value="&" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="@"
                   value="@" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key='"'
                   value='"' font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 -0.5 0"
        >
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: switchKb2; keyCode:17;"
                gui-button=" text:#+=; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="."
                   value="." font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=","
                   value="," font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="?"
                   value="?" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="!"
                   value="!" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="'"
                   value="'" font-family="Fira Sans"
          ></a-gui-button>
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: keypress; key:Backspace;"
                gui-icon-label-button="icon:backspace; text:; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>
      </a-entity>
        <a-entity id="keyboardChar" visible="false" position="0 -10 -1">
        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0.5 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="["
                   value="[" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="]"
                   value="]" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="{"
                   value="{" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="}"
                   value="}" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="#"
                   value="#" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="%"
                   value="%" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="^"
                   value="^" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="*"
                   value="*" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="+"
                   value="+" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="="
                   value="=" font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="_"
                   value="_" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="\"
                   value="\" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="|"
                   value="|" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="~"
                   value="~" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="<"
                   value="<" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=">"
                   value=">" font-family="Fira Sans"
          ></a-gui-button>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; keyCode:69;" euro
                gui-button=" text:€; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; keyCode:76;" pound_sterling
                gui-button=" text:char#163; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; keyCode:89;" yen_sign
                gui-button=" text:char#165; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: keypress; keyCode:8226;" bullet
                gui-button="text:char#8226; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 -0.5 0"
        >
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: switchKb2; keyCode:17;"
                gui-button=" text:123; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="."
                   value="." font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key=","
                   value="," font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="?"
                   value="?" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="!"
                   value="!" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="*"
                   value="(" font-family="Fira Sans"
          ></a-gui-button>
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                                   gui-interactable="clickAction: keypress; key:Backspace;"
                                   gui-icon-label-button="icon:backspace; text:; fontFamily:'Fira Sans';"
        ></a-entity>

        </a-entity>
      </a-entity>
        <a-entity id="keyboardAbcHigh" visible="false" position="0 -10 -1">
        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0.5 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="Q"
                   value="Q" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="W"
                   value="W" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="E"
                   value="E" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="R"
                   value="R" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="T"
                   value="T" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="Y"
                   value="Y" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="U"
                   value="U" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="I"
                   value="I" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="O"
                   value="O" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="P"
                   value="P" font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="A"
                   value="A" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="S"
                   value="S" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="D"
                   value="D" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="F"
                   value="F" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="G"
                   value="G" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="H"
                   value="H" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="J"
                   value="J" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="K"
                   value="K" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="L"
                   value="L" font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 -0.5 0"
        >
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: switchKbToAbcLow; keyCode:16;" id="shiftDown"
                gui-icon-label-button="icon:arrow-down-a; text:; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="Z"
                   value="Z" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="X"
                   value="X" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="C"
                   value="C" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="V"
                   value="V" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="B"
                   value="B" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="N"
                   value="N" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="M"
                   value="M" font-family="Fira Sans"
          ></a-gui-button>
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                 gui-interactable="clickAction: keypress; key:Backspace;"
                 gui-icon-label-button="icon:backspace; text:; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>
      </a-entity>
        <a-entity id="keyboardAbcLow" visible="true" position="0 0 0">
        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0.5 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="q"
                   value="q" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="w"
                   value="w" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="e"
                   value="e" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="r"
                   value="r" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="t"
                   value="t" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="y"
                   value="y" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="u"
                   value="u" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="i"
                   value="i" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="o"
                   value="o" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="p"
                   value="p" font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 0 0"
        >
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="a"
                   value="a" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="s"
                   value="s" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="d"
                   value="d" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="f"
                   value="f" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="g"
                   value="g" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="h"
                   value="h" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="j"
                   value="j" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="k"
                   value="k" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="l"
                   value="l" font-family="Fira Sans"
          ></a-gui-button>
        </a-entity>

        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 -0.5 0"
        >
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: switchKbToAbcHigh; keyCode:16;" id="shiftUp"
                gui-icon-label-button="icon:arrow-up-a; text:; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="z"
                   value="z" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="x"
                   value="x" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="c"
                   value="c" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="v"
                   value="v" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="b"
                   value="b" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="n"
                   value="n" font-family="Fira Sans"
          ></a-gui-button>
          <a-gui-button width="0.5" height="0.5"
                   onclick="keypress" key="m"
                   value="m" font-family="Fira Sans"
          ></a-gui-button>
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                 gui-interactable="clickAction: keypress; key:Backspace;"
                 gui-icon-label-button="icon:backspace; text:; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>
      </a-entity>
        <a-entity id="keyboardNav">
        <a-entity   gui-item="type: flex-container; width: 5.25; height: 0.5;"
              gui-flex-container="flexDirection: row; justifyContent: center; alignItems: normal; componentPadding: 0.1; opacity: 0.7"
              position="0 -1 0"
        >
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;" id="navkbSwitch"
                  gui-interactable="clickAction: switchKb; keyCode:9;"
                gui-button=" text:123; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.5; height: 0.5;"
                  gui-interactable="clickAction: voicecontrol;"
                gui-icon-label-button="icon:android-microphone; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 3; height: 0.5;"
                  gui-interactable="clickAction: keypress; keyCode:32;" id="space"
                gui-button=" text:space; fontFamily:'Fira Sans';"
          ></a-entity>
          <a-entity   gui-item="type: button; width: 0.75; height: 0.5;"
                  gui-interactable="clickAction: enter; keyCode:13;" id="enter"
                gui-button=" text:Go; fontFamily:'Fira Sans';"
          ></a-entity>
        </a-entity>
      </a-entity>
    </a-entity>


    <!-- Camera + cursor. 
    <a-entity id="cameraRig" position="0 1.6 0">
      <a-camera look-controls wasd-controls position="0 0 0">
        <a-gui-cursor id="cursor"
              raycaster="objects: [gui-interactable]"
              fuse="true" fuse-timeout="2000"
              design="ring"
        >
        </a-gui-cursor> 
      </a-camera> 
    </a-entity>
    -->

    <div style="width: 100%; height: 100%; position: fixed; left: 0; top: 0; z-index: -1; overflow: hidden">
      <div id="htmlElement" style="background: #fff; color:#000; font-size: 60px; width:1500px; height: 600px;"></div>
    </div>



    <a-gui-flex-container
      flex-direction="row" justify-content="center" align-items="normal" component-padding="0.1"
      opacity="0.7" width="3" height="1"
      position="0 -100 -4" rotation="0 0 0" scale="0.5 0.5 0.5"
    >
      <a-gui-icon-button
        width="0.75" height="0.75"
        onclick="togglePlayback"
        icon="skip-backward"
      >
      </a-gui-icon-button>
      <a-gui-icon-button
        width="0.75" height="0.75"
        onclick="stop"
        icon="skip-forward"
      >
      </a-gui-icon-button>
      
      </a-gui-toggle>
    </a-gui-flex-container>

    <a-sky thisimg src="https://cors-anywhere.herokuapp.com/https://images.mapillary.com/Jqum6TdBCIg5pams-Ey20w/thumb-2048.jpg" rotation="0 -130 0" id="my-image"></a-sky>

    <a-entity id="leftHand" laser-controls="hand: left" raycaster="objects: [gui-interactable]"></a-entity>
    <a-entity id="rightHand" laser-controls="hand: right" raycaster="objects: [gui-interactable]" line="color: #118A7E"></a-entity>



  </a-scene>

  <script type="text/javascript">

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-0.93875203281641,51.005568447565174],
      zoom: 18
    });

    var geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      mapboxgl: mapboxgl
    });
    document.getElementById('test_input').appendChild(geocoder.onAdd(map));

    geocoder.on('results', function(results) {
       console.log(results);
    })


    //document.getElementById('test_input').value = 'london';






    




    var images = [];

    var seqPos = 0;




    function getSeq(coords) {

      var point = turf.point(coords);
      var buffered = turf.buffer(point, 5, {units: 'miles'});
      var bbox = turf.bbox(buffered);


      



      
      var imglink = "https://a.mapillary.com/v3/images?bbox=" + bbox + "&pano=true&per_page=1&client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";
      console.log(imglink);
      $.getJSON(imglink)
      .done(function(imgdata){

        console.log(imgdata.features[0].properties.sequence_key);



        var seqlink = "https://a.mapillary.com/v3/sequences/" + imgdata.features[0].properties.sequence_key + "?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";
        console.log(seqlink);
        $.getJSON(seqlink)
        .done(function(seqdata){

          window.data = seqdata;

          console.log(seqdata);

          images = [];
          seqPos = 0;


          

          seqdata.properties.coordinateProperties.image_keys.forEach(function(img,index) {
            images.push(img);

            


            



          })

          paintSpots()

          console.log(images);

          var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
          document.querySelector('#my-image').setAttribute('src', imageUrl);

        })


      })
      

    }
    


    var thisSeq = '0-UskBD78xAsg2c9CL0Yag';
    var link = "https://a.mapillary.com/v3/sequences/" + thisSeq + "?client_id=ZzY1cV9tVkxZZVE5SXpMU09WNlZOQTpiMjMwZWVlMmIyMDY3ZDlh";

    $.getJSON(link)
      .done(function(data){

        window.data = data;

        data.properties.coordinateProperties.image_keys.forEach(function(img,index) {
          images.push(img);

        })

        paintSpots()


        console.log(images);
    })


      var i = 0;



      function paintSpots() {

        console.log(data)

        var centerLng = data.geometry.coordinates[seqPos][0];
        var centerLat = data.geometry.coordinates[seqPos][1];
        var center = turf.point([centerLng,centerLat]);
        console.log(centerLng,centerLat)

          i = 0;

          data.geometry.coordinates.forEach(function(coords,index) {



            if (index < 9) {

                console.log(seqPos)

                console.log(coords)
                
                let latitude = coords[1];
                let longitude = coords[0];

                console.log(longitude,latitude)
                // threejs json
                var pointX = turf.point([longitude,centerLat]);
                var pointY = turf.point([centerLng,latitude]);
                var distanceX = turf.distance(pointX, center, {units: 'kilometers'});
                var distanceY = turf.distance(pointY, center, {units: 'kilometers'});

                var offsetX = (centerLng- longitude) * 3000;
                var offsetY = (centerLat - latitude) * 3000;

                //addMapillaryPoint(offsetX,offsetY);

                

                //var difference = function (a, b) { return Math.abs(a - b); }

                //var diff = difference(index,5);
                //console.log(index)
                //console.log(diff)

                //var mid = index - diff;

                document.querySelector('#img-'+i).setAttribute('position', {x: offsetY, y: -100, z: offsetX});

                i++

                console.log(index)
                console.log(i)

              
            }


          })
        }















    function jumpToPosition(e) {
      

      var pos = e.path[0].id.slice(-1);
      console.log(pos)

      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[pos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);

      var newSeqPos = parseInt(seqPos) + parseInt(pos);
      seqPos = newSeqPos;

      console.log(seqPos)

      paintSpots()
    }





    function togglePlayback () {

      //document.querySelector('#my-image').setAttribute('src', 'https://sjmarshalluk.github.io/3d-editor/w-16QEt1P1EMvhFtxlc9Tw.jpg');

      


      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);
      seqPos++


    }
    function stop () {
      var imageUrl = 'https://cors-anywhere.herokuapp.com/https://images.mapillary.com/' + images[seqPos] + '/thumb-2048.jpg'
      document.querySelector('#my-image').setAttribute('src', imageUrl);
      seqPos++
    }
    function toggleSound () {
      

    }
    function toggleCaps () {
      
    }







    window.switchKb = function() {
        var keyboardAbcLow = document.getElementById("keyboardAbcLow");
        var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
        var keyboardNum = document.getElementById("keyboardNum");
        var keyboardChar = document.getElementById("keyboardChar");

      if( keyboardAbcLow.getAttribute('position').y == 0){
        window.kbAbcLow = false;
        window.kbAbcHigh = false;
        window.kbNum = true;
        window.kbChar = false;
        toggleKb(window.kbNum);
      }else{
        window.kbAbcLow = true;
        window.kbAbcHigh = false;
        window.kbNum = false;
        window.kbChar = false;
        toggleKb(window.kbAbcLow);
      }
    }

    window.switchKb2 = function() {
        var keyboardAbcLow = document.getElementById("keyboardAbcLow");
        var keyboardAbcHigh = document.getElementById("keyboardAbcHigh");
        var keyboardNum = document.getElementById("keyboardNum");
        var keyboardChar = document.getElementById("keyboardChar");

      if(old_timestamp == null || old_timestamp + 100 < event.timeStamp){ //prevent multiple clicks when using keyboard

        if( keyboardNum.getAttribute('position').y == 0){
          window.kbAbcLow = false;
          window.kbAbcHigh = false;
          window.kbNum = false;
          window.kbChar = true;
          toggleKb(window.kbChar);
        }else{
          window.kbAbcLow = false;
          window.kbAbcHigh = false;
          window.kbNum = true;
          window.kbChar = false;
          toggleKb(window.kbNum);
        }
        old_timestamp = event.timeStamp;
      }
    }

    window.addEventListener("keyup", function (event) {
      if (event.defaultPrevented) {
        return; // Do nothing if the event was already processed
      }
      switch (event.keyCode) {
        case 16: // shift
            console.log("shift key release");
            document.getElementById("shiftDown").emit('click');
            break;
        default:
            return; // Quit when this doesn't handle the key event.
        }
      event.preventDefault();
    }, true);



    window.keyCodeToChar = {8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause/Break",20:"Caps Lock",27:"Esc",32:"Space",33:"Page Up",34:"Page Down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"Windows",93:"Right Click",96:"Numpad 0",97:"Numpad 1",98:"Numpad 2",99:"Numpad 3",100:"Numpad 4",101:"Numpad 5",102:"Numpad 6",103:"Numpad 7",104:"Numpad 8",105:"Numpad 9",106:"Numpad *",107:"Numpad +",109:"Numpad -",110:"Numpad .",111:"Numpad /",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"Num Lock",145:"Scroll Lock",182:"My Computer",183:"My Calculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"};



    var searchTerm = '';

    window.keypress = function(event) {

      console.log('in window.keypress');
      if(window.old_timestamp == null || window.old_timestamp + 100 < event.timeStamp){ //prevent multiple clicks when using keyboard

        var keyCode = 222;
        var key = null;
        var text = null;

        if(event.target.parentEl.components['gui-interactable']){
          console.log('using parent el: ' + event.target.parentEl.id);
          keyCode = event.target.parentEl.components['gui-interactable']['data']['keyCode'];
          key = event.target.parentEl.components['gui-interactable']['data']['key'];
          var buttonComponent = event.target.parentEl.components['gui-button'];
          var iconButtonComponent = event.target.parentEl.components['gui-icon-button'];
          var iconLabelButtonComponent = event.target.parentEl.components['gui-icon-label-button'];
          if (buttonComponent) {
            text = buttonComponent['data']['text'];
          } else if (iconButtonComponent) {
            text = iconButtonComponent['data']['text'];
          } else if (iconLabelButtonComponent) {
            text = iconLabelButtonComponent['data']['text'];
          }
          console.log("keyCode: " + keyCode);
          console.dir(event.target.parentEl.components['gui-interactable']['data']['keyCode']);
          console.log("keypressed with button: " + keyCode);
        } else {
          console.log('using el: ' + event.target.parentEl.id);
          keyCode = event.target.components['gui-interactable']['data']['keyCode'];
          key = event.target.components['gui-interactable']['data']['key'];
          var buttonComponent = event.target.components['gui-button'];
          var iconButtonComponent = event.target.components['gui-icon-button'];
          var iconLabelButtonComponent = event.target.components['gui-icon-label-button'];
          if (buttonComponent) {
            text = buttonComponent['data']['text'];
          } else if (iconButtonComponent) {
            text = iconButtonComponent['data']['text'];
          } else if (iconLabelButtonComponent) {
            text = iconLabelButtonComponent['data']['text'];
          }
          console.log("keypressed with keyboard: " + keyCode);
        }

        //var textField = document.getElementById("htmlElement");
        //textField.textContent += window.keyCodeToChar[keyCode];
        // var char = window.keyCodeToChar[keyCode];
        if (!text) {
          text = String.fromCharCode(keyCode);
          if (keyCode >= 65 || keyCode <= 90) {
            text = text.toLowerCase();
          }
        }
        var textField = document.getElementById("test_input");
        if (key === 'Backspace') {
          textField.components['gui-input'].delete();
        } else if (text === 'space') {
          textField.components['gui-input'].appendText(' ');
        } else {
          textField.components['gui-input'].appendText(text);

        }
        window.old_timestamp = event.timeStamp;
      }
    }

    window.voicecontrol = function() {
      console.log("voicecontrol");
    }

    window.enter = function() {
      console.log("enter");

      //var textField = document.getElementById("test_input");
      var textField = document.getElementById("test_input");
      var searchTerm = textField.components['gui-input'].oldText;

      console.log(searchTerm);


      var geolink = "https://api.mapbox.com/geocoding/v5/mapbox.places/" + searchTerm + ".json?access_token=pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng";
      $.getJSON(geolink)
        .done(function(data){
          console.log(data)

          getSeq(data.features[0].center)

          var textField = document.getElementById("test_input");
          

      });
    }




    

    </script>

</body>
</html>
