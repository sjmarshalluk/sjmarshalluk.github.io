<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display driving directions</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" type="text/css" />

  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
<style>
  body { margin: 0; padding: 0; }
  #map { 
    position: absolute; 
    top: 0; 
    bottom: 0; 
    width: 100%; 
  }

  .mapboxgl-ctrl-directions { display: none }


  #map-wrap { 
    position: absolute; 
    bottom: 0; 
    width: 100%; 
    height: 100%; 
    z-index: 10; 
    transition: 0.5s;
    overflow: hidden;
  }
  #map-wrap.half {
    height: 45%; 
  }
  #map-wrap.perspective {
    perspective: 450px;
    height: 750px;
  }
  #map-wrap.perspective #map {
    transform-style: preserve-3d;
    transform: rotateX(45deg);
  }

  #video {
    z-index: -1;
    left: 0;
    bottom: 0px;
    position: fixed;
    opacity: 1;
    min-width: 100%;
    min-height: 100%;
  }

  #panel {
    width: 100%;
    height: 200px;
    background-color: #fff;
    border-radius: 20px 20px 0 0;
    bottom: -200px;
    position: absolute;
    z-index: 1000;
    transition: 0.2s;
  }
  #panel.open {
    bottom: 0!important;
  }

  #reloc {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
    background-color: rgba(0,0,0,0.5);
    color: #fff;
    z-index: 2000;
    display: none;
  }

  .AttributionContainer { display: none; }
  .BearingIndicatorContainer  { display: none; }
  .ZoomContainer  { display: none; }

  .mapboxgl-ctrl-logo,
  .mapboxgl-ctrl-attrib {
    display: none!important
  }
</style>
</head>
<body>



  <a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button" style="position: absolute; z-index: 9999">Start the demo!</a>

  <div id="map-wrap">
    <div id="map"></div>
  </div>

  <video id="video" autoplay playsinline></video>

  <div id="reloc">
    Pan around
  </div>

  <div id="panel">

  </div>
 
<script>


var panelHeight = '100px';




document.getElementById('panel').style.height = panelHeight;
document.getElementById('panel').style.bottom = '-' + panelHeight;









const video = document.getElementById('video');
const videoConstraints = {
    facingMode: 'environment'
  };
  const constraints = {
    video: videoConstraints,
    audio: false
  };

  navigator.mediaDevices
    .getUserMedia(constraints)
    .then(stream => {
      video.srcObject = stream;
    })
    .catch(error => {
      console.error(error);
    });



mapboxgl.accessToken = 'pk.eyJ1Ijoic2ptYXJzaGFsbHVrIiwiYSI6ImNpeDBleG1hdjAwNGEyenBoODAxODRxeGkifQ.tad1YtixbGXoQGGF_Z84Ng';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v11',
  center: [-79.4512, 43.6568],
  zoom: 13,
  pitch: 0
});


map.on('load', function() {

})




var directions = new MapboxDirections({
  accessToken: mapboxgl.accessToken,
  interactive: false
});
map.addControl(directions);

getStartLocation();

function getStartLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition);
  } else {
    console.log("Geolocation is not supported by this browser.");
  }
}

function showPosition(position) {
  window.startPosition = [position.coords.longitude, position.coords.latitude];
  map.jumpTo({ center: [position.coords.longitude, position.coords.latitude] });

  directions.setOrigin([position.coords.longitude, position.coords.latitude]);
  
}


map.on('click', function(e) {
  console.log(e)
  directions.setDestination([e.lngLat.lng,e.lngLat.lat]);
})


/*
map.on('mousedown', function(e) {

  console.log('down')
  setTimeout(function() { 
    map.on('mouseup', function(e) {
      console.log('up')
      console.log(e)
      directions.setDestination([e.lngLat.lng,e.lngLat.lat]);
    });
  },300);
  
  //console.log('A mousedown event has occurred.');
});

var time = 0;
map.on('mousedown', function(e) {
  setTimeout(function() { 
    time = 1;

  },500);

  console.log('down')

  //console.log('A mousedown event has occurred.');
});
map.on('mouseup', function(e) {
  console.log('up')
  console.log(e)

  if (time > 0) {
    directions.setDestination([e.lngLat.lng,e.lngLat.lat]);
  }
});
*/


directions.on('route', function(e) {

  zoomToPath(e)

  
  
     
    
  map.setPaintProperty('directions-route-line-alt', 'line-opacity', 0);
  map.setPaintProperty('directions-route-line', 'line-opacity', 1);
  map.setPaintProperty('directions-route-line', 'line-width', 20);
  map.setPaintProperty('directions-route-line-casing', 'line-opacity', 0);

  map.setPaintProperty('directions-hover-point-casing', 'circle-opacity', 0);
  map.setPaintProperty('directions-hover-point', 'circle-opacity', 0);
  map.setPaintProperty('directions-waypoint-point-casing', 'circle-opacity', 0);
  map.setPaintProperty('directions-waypoint-point', 'circle-opacity', 0);
  map.setPaintProperty('directions-origin-point', 'circle-opacity', 0);
  //map.setPaintProperty('directions-origin-label', 'circle-opacity', 0);
  map.setPaintProperty('directions-destination-point', 'circle-opacity', 0);
  //map.setPaintProperty('directions-destination-label', 'circle-opacity', 0);



  map.moveLayer('directions-route-line', 'tunnel-street-minor-low')


  var layers = map.getStyle().layers;
  console.log(layers);


  showPanel();

});



function showPanel() {
  var panel = document.getElementById('panel');
  panel.classList.add('open');


  var startBtn = panel.appendChild(document.createElement('button'));
  startBtn.innerHTML = 'Start';
  startBtn.addEventListener('click', function() {
    document.getElementById('panel').classList.remove('open');
    //startReloc();
    startVpsNav();
  })

}




function startReloc() {
  
  document.getElementById('map').style.top = '100%';
  document.getElementById('reloc').style.display = 'inline';

  setTimeout(function() { 
    endReloc();
  },2000);
}


function endReloc() {
  //document.getElementById('panel').classList.remove('open');
  document.getElementById('map').style.top = '0';
  document.getElementById('reloc').style.display = 'none';

  startVpsNav();
}



function startVpsNav() {
  document.getElementById('map-wrap').classList.add('half');
  map.setPitch(60); //change to phone sensors
  map.setBearing(startBearing); //
  
  setTimeout(function() { 
    map.resize();
    setTimeout(function() { 
      map.flyTo({center: startPosition, zoom: 20});
    },400);
  },400);

  setTimeout(function() { 
    //getNewLocation()
  },3000);

  reduceLayers()



}



function reduceLayers() {
  //map.setStyle('mapbox://styles/mapbox/light-v10');
  

  setTimeout(function() { 
    map.setPaintProperty('land', 'background-opacity', 0.2);
    //map.setLayoutProperty('land', 'visibility', 'none');

    map.setPaintProperty('road-label', 'text-opacity', 0);



    map.setPaintProperty('road-pedestrian', 'line-opacity', 0);
    map.setPaintProperty('road-path', 'line-opacity', 0);
    map.setPaintProperty('road-pedestrian-case', 'line-opacity', 0);
  },300);

  setTimeout(function() { 
    addBuildings();
  },600);
  

}






function getNewLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showNewPosition);
  } else {
    console.log("Geolocation is not supported by this browser.");
  }
}
function showNewPosition(position) {
  map.flyTo({ center: [position.coords.longitude, position.coords.latitude] });


  var point = turf.point([position.coords.longitude, position.coords.latitude]);
  window.bufferedPoint = turf.buffer(point, 0.002, {units: 'kilometers'});

  if (map.getLayer('currentPoint')) {
    map.removeLayer('currentPoint');
  }
  if (map.getSource('currentPoint')) {
    map.removeSource('currentPoint');
  }

  map.addSource('currentPoint', {
    'type': 'geojson',
    'data': bufferedPoint
  });

  map.addLayer({
    'id': 'currentPoint',
    'type': 'fill-extrusion',
    'source': 'currentPoint',
    'paint': {
      'fill-extrusion-color': '#286412',
      'fill-extrusion-height': 0.2,
      'fill-extrusion-base': 0,
      'fill-extrusion-opacity': 0.5
    }
  });

}



function zoomToPath(e) {
  var path = {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "properties": {},
        "geometry": {
          "type": "LineString",
          "coordinates": []
        }
      }
    ]
  }

  
  e.route[0].legs[0].steps.forEach(function (point) {
    path.features[0].geometry.coordinates.push(point.maneuver.location);
    console.log(point.maneuver.location)
  });

  var bbox = turf.bbox(path);

  map.fitBounds(bbox, {
    padding: {top: 100, bottom:300, left: 100, right: 100}
  });


  console.log(path.features[0].geometry.coordinates[0])
  var point1 = turf.point(path.features[0].geometry.coordinates[0]);
  var point2 = turf.point(path.features[0].geometry.coordinates[1]);

  window.startBearing = turf.bearing(point1, point2);
}






function addBuildings() {

  // Insert the layer beneath any symbol layer.
  var layers = map.getStyle().layers;
   
  var labelLayerId;
  for (var i = 0; i < layers.length; i++) {
  if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
  labelLayerId = layers[i].id;
  break;
  }
  }
   
  map.addLayer(
  {
  'id': '3d-buildings',
  'source': 'composite',
  'source-layer': 'building',
  'filter': ['==', 'extrude', 'true'],
  'type': 'fill-extrusion',
  'minzoom': 15,
  'paint': {
  'fill-extrusion-color': '#aaa',
   
  // use an 'interpolate' expression to add a smooth transition effect to the
  // buildings as the user zooms in
  'fill-extrusion-height': [
  'interpolate',
  ['linear'],
  ['zoom'],
  15,
  0,
  15.05,
  ['get', 'height']
  ],
  'fill-extrusion-base': [
  'interpolate',
  ['linear'],
  ['zoom'],
  15,
  0,
  15.05,
  ['get', 'min_height']
  ],
  'fill-extrusion-opacity': 0.6
  }
  },
  labelLayerId
  );
}


function handleOrientationPath(event) {

  /*
  var OldRange = (90 - 0);
  var NewRange = (200 - 110);
  var NewValue = (((OldValue - OldMin) * NewRange) / OldRange) + NewMin;
  */

  if (event.beta > 0 && event.beta < 90) {
    var perspective = event.beta * 10;

    document.getElementById('map-wrap').style.perspective = perspective + "px";
    
  }
}


function handleOrientation(event) {

  if (event.beta > 0 && event.beta < 90) {
    //var perspective = event.beta + 100;
    //document.getElementById('map-wrap').style.perspective = perspective;

    //THIS IS FOR PERSPECTIVE  document.getElementById('map').style.transform = "rotateX(" + event.beta + "deg)";


    map.setPitch(event.beta);
  }


  

  //var bearing = event.gamma - (event.gamma * 2);
  //map.setBearing(bearing);

  /*
    map.lookAt({ tilt: event.beta });

    //var rotation = event.gamma - (event.gamma * 2);
    map.lookAt({ heading: event.gamma });
  */

  if (event.webkitCompassHeading) {
        absoluteHeading = event.webkitCompassHeading;
    } else {
        absoluteHeading = event.alpha;
    }
    console.log(absoluteHeading);
    map.setBearing(absoluteHeading);

    
  updateFieldIfNotNull('Orientation_a', event.alpha);
  updateFieldIfNotNull('Orientation_b', event.beta);
  updateFieldIfNotNull('Orientation_g', event.gamma);
    
  
}

function manageCompass(event) {
    
}


let is_running = false;
let demo_button = document.getElementById("start_demo");
demo_button.onclick = function(e) {
  e.preventDefault();
  demo_button.style.display = 'none';
  if (
    DeviceMotionEvent &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission();
  }
  
  if (is_running){
    //window.removeEventListener("devicemotion", handleMotion);
    window.removeEventListener("deviceorientation", handleOrientation);
    //window.removeEventListener('deviceorientation', manageCompass);
    demo_button.innerHTML = "Start demo";
    demo_button.classList.add('btn-success');
    demo_button.classList.remove('btn-danger');
    is_running = false;
  }else{
    //window.addEventListener("devicemotion", handleMotion);
    window.addEventListener("deviceorientation", handleOrientation);
    window.addEventListener("deviceorientation", handleOrientationPath);
    //window.addEventListener('deviceorientation', manageCompass);
    document.getElementById("start_demo").innerHTML = "Stop demo";
    demo_button.classList.remove('btn-success');
    demo_button.classList.add('btn-danger');
    is_running = true;
  }
};
 
</script>
 
</body>
</html>